<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù†ÙˆØ¹ÙŠØ© - ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ©</title>
    <style>
        .input-group { margin-bottom: 15px; }
        input, textarea, select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--orange); 
            background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; 
        }
        label { display: block; margin-bottom: 5px; color: var(--yellow); font-weight: bold; }
        .edit-mode { border: 2px solid #27ae60 !important; box-shadow: 0 0 15px rgba(39, 174, 96, 0.4); }
    </style>
</head>
<body>
    <nav>
        <a href="admin_hub.html" class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª QC ğŸ› ï¸</a>
        <button class="btn-primary" onclick="location.href='admin_hub.html'" style="width:auto; padding: 5px 15px;">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </nav>

    <div class="container">
        <div class="card" id="form-container">
            <h2 id="form-title" style="color:var(--orange); text-align:center;">â• Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø¬ÙˆØ¯Ø©</h2>
            
            <div class="input-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                    <input type="text" id="qc-name">
                </div>
                <div class="input-group">
                    <label>Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
                    <select id="qc-device">
                        <option value="X-ray">Ø§Ù„Ø£Ø´Ø¹Ø© Ø§Ù„Ø³ÙŠÙ†ÙŠØ© (X-ray)</option>
                        <option value="CT">Ø§Ù„Ù…ÙØ±Ø§Ø³ (CT)</option>
                        <option value="MRI">Ø§Ù„Ø±Ù†ÙŠÙ† (MRI)</option>
                        <option value="US">Ø§Ù„Ø³ÙˆÙ†Ø§Ø± (US)</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>ğŸ¯ Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Goal):</label>
                <input type="text" id="qc-goal" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù‚Ø© ÙØ±Ù‚ Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨">
            </div>

            <div class="input-group">
                <label>ğŸ› ï¸ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Tools):</label>
                <input type="text" id="qc-tools" placeholder="Ù…Ø«Ù„Ø§Ù‹: kVp Meter, Dosimeter, Copper Filters">
            </div>

            <div class="input-group">
                <label>ğŸ“ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Procedure):</label>
                <textarea id="qc-proc" rows="4"></textarea>
            </div>

            <div class="input-group">
                <label>âš–ï¸ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„ (Tolerance):</label>
                <input type="text" id="qc-limit">
            </div>

            <div class="input-group">
                <label>ğŸ–¼ï¸ ØµÙˆØ±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©:</label>
                <input type="file" id="qc-img" accept="image/*">
                <div id="img-preview-container" style="display:none; margin-top:10px;">
                    <img id="img-preview" style="width:100px; border-radius:8px; border:1px solid var(--yellow);">
                </div>
            </div>
            
            <button id="submit-btn" class="btn-primary" onclick="saveQCTest()">ğŸš€ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨</button>
            <button id="cancel-btn" class="btn-primary" style="display:none; background:#555; margin-top:10px;" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <div class="card">
            <h3 style="color:var(--yellow);">ğŸ“‚ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
            <div id="qc-list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const COLLECTION = "qc_tests";
        let editingId = null;
        let currentImgBase64 = "";

        async function saveQCTest() {
            const name = document.getElementById('qc-name').value;
            const device = document.getElementById('qc-device').value;
            const goal = document.getElementById('qc-goal').value; // Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯
            const tools = document.getElementById('qc-tools').value; // Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯
            const proc = document.getElementById('qc-proc').value;
            const limit = document.getElementById('qc-limit').value;
            const imgFile = document.getElementById('qc-img').files[0];

            if(!name || !proc) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©!");

            let imageData = currentImgBase64;
            if (imgFile) {
                imageData = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(imgFile);
                });
            }

            const qcData = { name, device, goal, tools, proc, limit, img: imageData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };

            try {
                if(editingId) {
                    await db.collection(COLLECTION).doc(editingId).update(qcData);
                } else {
                    qcData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection(COLLECTION).add(qcData);
                }
                alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                resetForm();
                loadQCTests();
            } catch (e) { alert("Ø®Ø·Ø£: " + e.message); }
        }

        async function loadQCTests() {
            const list = document.getElementById('qc-list');
            const snap = await db.collection(COLLECTION).orderBy("createdAt", "desc").get();
            list.innerHTML = snap.docs.map(doc => {
                const item = doc.data();
                return `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #333;">
                    <span><b>${item.name}</b> <small style="color:var(--orange)">(${item.device})</small></span>
                    <div>
                        <button onclick='prepareEdit("${doc.id}", ${JSON.stringify(item).replace(/'/g, "&apos;")})' style="color:var(--yellow); background:none; cursor:pointer; margin-left:10px;">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteQC('${doc.id}')" style="color:#e74c3c; background:none; cursor:pointer;">Ø­Ø°Ù</button>
                    </div>
                </div>`;
            }).join('');
        }

        function prepareEdit(id, data) {
            editingId = id;
            document.getElementById('qc-name').value = data.name;
            document.getElementById('qc-device').value = data.device;
            document.getElementById('qc-goal').value = data.goal || ""; // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            document.getElementById('qc-tools').value = data.tools || ""; // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            document.getElementById('qc-proc').value = data.proc;
            document.getElementById('qc-limit').value = data.limit;
            currentImgBase64 = data.img || "";
            if(data.img) {
                document.getElementById('img-preview').src = data.img;
                document.getElementById('img-preview-container').style.display = "block";
            }
            document.getElementById('form-title').innerText = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± QC";
            document.getElementById('submit-btn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('cancel-btn').style.display = "block";
            document.getElementById('form-container').classList.add('edit-mode');
        }

        async function deleteQC(id) {
            if(confirm("Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await db.collection(COLLECTION).doc(id).delete();
                loadQCTests();
            }
        }

        function resetForm() {
            editingId = null; currentImgBase64 = "";
            document.getElementById('qc-name').value = "";
            document.getElementById('qc-goal').value = "";
            document.getElementById('qc-tools').value = "";
            document.getElementById('qc-proc').value = "";
            document.getElementById('qc-limit').value = "";
            document.getElementById('qc-img').value = "";
            document.getElementById('img-preview-container').style.display = "none";
            document.getElementById('form-title').innerText = "â• Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø± Ø¬ÙˆØ¯Ø© Ø¬Ø¯ÙŠØ¯";
            document.getElementById('submit-btn').innerText = "ğŸš€ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨";
            document.getElementById('cancel-btn').style.display = "none";
            document.getElementById('form-container').classList.remove('edit-mode');
        }

        window.onload = loadQCTests;
    </script>
</body>
</html>