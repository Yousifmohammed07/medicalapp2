<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ø¯ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…Ø© - ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ©</title>
    <style>
        .input-group { margin-bottom: 15px; }
        input, textarea, select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--yellow); 
            background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; 
        }
        label { display: block; margin-bottom: 5px; color: var(--orange); font-weight: bold; }
        .edit-badge { background: var(--yellow); color: var(--navy); padding: 5px 10px; border-radius: 5px; display: none; margin-bottom: 10px; font-weight: bold; }
        .preview-img { width: 120px; border-radius: 10px; margin-top: 10px; border: 1px solid var(--orange); display: none; }
        .data-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; }
    </style>
</head>
<body>
    <nav>
        <a href="admin_hub.html" class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ğŸ›¡ï¸</a>
        <button class="btn-primary" onclick="location.href='admin_hub.html'" style="width:auto; padding: 5px 15px;">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </nav>

    <div class="container">
        <div class="card">
            <div id="edit-indicator" class="edit-badge">ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù†Ø´Ø· âœï¸</div>
            <h2 id="form-title" style="color:var(--yellow); text-align:center;">ğŸ›¡ï¸ Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠ Ø³Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯</h2>
            
            <div class="input-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø¬Ø³Ù…/Ø§Ù„Ø£Ø¯Ø§Ø©:</label>
                <input type="text" id="safe-item" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙƒØ±Ø³ Ù…ØªØ­Ø±ÙƒØŒ Ù…Ù‚ØµØŒ Ø­Ø§ÙˆÙŠØ© Ø£ÙˆÙƒØ³Ø¬ÙŠÙ†">
            </div>

            <div class="input-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø®ØµØµ:</label>
                <select id="safe-device">
                    <option value="MRI">Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ (MRI)</option>
                    <option value="CT">Ø§Ù„Ù…ÙØ±Ø§Ø³ (CT)</option>
                    <option value="X-ray">Ø§Ù„Ø£Ø´Ø¹Ø© Ø§Ù„Ø³ÙŠÙ†ÙŠØ© (X-ray)</option>
                </select>
            </div>

            <div class="input-group">
                <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ù„Ø§Ù…Ø©:</label>
                <select id="safe-status">
                    <option value="safe">Ø¢Ù…Ù† âœ… (Safe)</option>
                    <option value="unsafe">Ø®Ø·Ø± âŒ (Unsafe)</option>
                    <option value="conditional">Ù…Ø³Ù…ÙˆØ­ Ø¨Ø´Ø±Ø· âš ï¸ (Conditional)</option>
                </select>
            </div>

            <div class="input-group">
                <label>Ø´Ø±Ø­ Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø¹Ù„Ù…ÙŠ):</label>
                <textarea id="safe-exp" rows="3" placeholder="Ø§Ø´Ø±Ø­ Ù„Ù…Ø§Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©..."></textarea>
            </div>

            <div class="input-group">
                <label>ØµÙˆØ±Ø© Ø§Ù„ØªØ­Ø¯ÙŠ:</label>
                <input type="file" id="safe-img" accept="image/*">
                <img id="edit-preview" class="preview-img">
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-primary" id="save-btn" onclick="saveSafetyChallenge()">ğŸš€ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨</button>
                <button class="btn-primary" id="cancel-btn" style="background:#555; display:none;" onclick="location.reload()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>

        <div class="card">
            <h3 style="color:var(--orange);">ğŸ“‚ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹:</h3>
            <div id="safety-list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let editingId = null;
        const COLLECTION = "safety"; // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù…Ù„Ù safety.html

        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
        firebase.auth().onAuthStateChanged((user) => { if (!user) window.location.href = "login.html"; });

        async function saveSafetyChallenge() {
            const item = document.getElementById('safe-item').value;
            const device = document.getElementById('safe-device').value;
            const status = document.getElementById('safe-status').value;
            const explanation = document.getElementById('safe-exp').value;
            const imgFile = document.getElementById('safe-img').files[0];
            const existingImg = document.getElementById('edit-preview').src;

            if(!item || !explanation) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©!");
            if(!imgFile && !editingId) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ø¯ÙŠ!");

            let imageData = existingImg || "";
            if (imgFile) {
                // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù€ Base64 Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸
                imageData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(imgFile);
                });
            }

            const data = {
                item: item,
                device: device,
                status: status,
                explanation: explanation,
                img: imageData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (editingId) {
                    await db.collection(COLLECTION).doc(editingId).update(data);
                    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection(COLLECTION).add(data);
                    alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠ Ù„Ù„Ø³Ø­Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ğŸš€");
                }
                location.reload();
            } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message); }
        }

        window.onload = async function() {
            const list = document.getElementById('safety-list');
            const snap = await db.collection(COLLECTION).orderBy("createdAt", "desc").get();
            
            if (snap.empty) { list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>"; return; }

            list.innerHTML = snap.docs.map(doc => `
                <div class="data-item">
                    <span><b>[${doc.data().device}]</b> ${doc.data().item}</span>
                    <div>
                        <button onclick="editChallenge('${doc.id}')" style="color:var(--yellow); background:none; border:none; cursor:pointer;">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteChallenge('${doc.id}')" style="color:red; background:none; border:none; cursor:pointer; margin-right:15px;">Ø­Ø°Ù</button>
                    </div>
                </div>
            `).join('');
        };

        async function editChallenge(id) {
            editingId = id;
            const doc = await db.collection(COLLECTION).doc(id).get();
            const d = doc.data();

            document.getElementById('safe-item').value = d.item;
            document.getElementById('safe-device').value = d.device;
            document.getElementById('safe-status').value = d.status;
            document.getElementById('safe-exp').value = d.explanation;
            
            const prev = document.getElementById('edit-preview');
            prev.src = d.img;
            prev.style.display = "block";

            document.getElementById('form-title').innerText = "ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠ";
            document.getElementById('edit-indicator').style.display = "block";
            document.getElementById('cancel-btn').style.display = "block";
            window.scrollTo(0,0);
        }

        async function deleteChallenge(id) {
            if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await db.collection(COLLECTION).doc(id).delete();
                location.reload();
            }
        }
    </script>
</body>
</html>