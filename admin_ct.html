<!DOCTYPE html>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="firebase-config.js"></script>

<script>
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ø§Ø·Ø±Ø¯Ù‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            window.location.href = "login.html";
        }
    });

    function logout() {
        firebase.auth().signOut().then(() => {
            window.location.href = "login.html";
        });
    }
</script>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙØ±Ø§Ø³ - ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ©</title>
    <style>
        .block-tool { border: 1px dashed var(--orange); padding: 15px; margin-bottom: 10px; border-radius: 10px; position: relative; }
        .remove-block { position: absolute; left: 10px; top: 10px; color: #ff4d4d; cursor: pointer; border: none; background: none; font-weight: bold; }
        .btn-add { background: #27ae60; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>
    <nav>
        <a href="admin_hub.html" class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±ÙˆØ³ CT â˜¢ï¸</a>
        <button class="btn-primary" onclick="location.href='admin_hub.html'" style="width:auto; padding: 5px 15px;">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø±ÙƒØ²</button>
    </nav>

    <div class="container">
        <div class="card">
            <h2 id="form-title" style="color:var(--yellow);">ğŸ§¬ Ø¨Ù†Ø§Ø¡ Ø¯Ø±Ø³ ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ù…ÙØ±Ø§Ø³</h2>
            
            <input type="text" id="titleAr" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: ÙˆØ­Ø¯Ø§Øª Ù‡Ø§ÙˆÙ†Ø³ÙÙŠÙ„Ø¯)" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid var(--orange); background:transparent; color:white;">
            <input type="text" id="titleEn" placeholder="Lesson Title (English)" dir="ltr" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid var(--orange); background:transparent; color:white;">

            <div id="blocks-container"></div>

            <div style="margin-top:20px; text-align:center;">
                <button class="btn-add" onclick="addTextBlock()">â• Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø±Ø© Ù†ØµÙŠØ©</button>
                <button class="btn-add" style="background:#2980b9;" onclick="addImageBlock()">ğŸ“· Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©</button>
            </div>

            <hr style="margin:30px 0; border:0.5px solid #444;">
            <button class="btn-primary" onclick="saveCTLesson()">ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…ÙØ±Ø§Ø³</button>
        </div>

        <div class="card">
            <h3 style="color:var(--orange);">ğŸ“‚ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
            <div id="ct-lessons-list"></div>
        </div>
    </div>

    <script>
        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø·Ø¹ Ù†ØµÙŠ
        function addTextBlock(val = "") {
            const id = Date.now();
            const html = `
                <div class="block-tool" id="block-${id}">
                    <button class="remove-block" onclick="removeBlock(${id})">Ø­Ø°Ù X</button>
                    <label style="color:var(--yellow)">Ù†Øµ Ø§Ù„Ø´Ø±Ø­ (ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª):</label>
                    <textarea class="block-data" data-type="text" rows="4" style="width:100%; margin-top:5px; background:rgba(255,255,255,0.05); color:white; border-radius:5px; padding:10px;">${val}</textarea>
                </div>`;
            document.getElementById('blocks-container').insertAdjacentHTML('beforeend', html);
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø·Ø¹ ØµÙˆØ±Ø©
        function addImageBlock() {
            const id = Date.now();
            const html = `
                <div class="block-tool" id="block-${id}">
                    <button class="remove-block" onclick="removeBlock(${id})">Ø­Ø°Ù X</button>
                    <label style="color:var(--yellow)">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ:</label>
                    <input type="file" onchange="handleImg(event, ${id})" accept="image/*" style="margin-top:5px; color:white;">
                    <input type="hidden" class="block-data" data-type="image" id="hidden-${id}">
                    <img id="preview-${id}" style="width:100%; max-height:200px; object-fit:contain; display:none; margin-top:10px; border-radius:10px; border:1px solid #555;">
                </div>`;
            document.getElementById('blocks-container').insertAdjacentHTML('beforeend', html);
        }

        function handleImg(e, id) {
            const reader = new FileReader();
            reader.onload = f => {
                document.getElementById(`preview-${id}`).src = f.target.result;
                document.getElementById(`preview-${id}`).style.display = "block";
                document.getElementById(`hidden-${id}`).value = f.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function removeBlock(id) { document.getElementById(`block-${id}`).remove(); }

        function saveCTLesson() {
            const titleAr = document.getElementById('titleAr').value;
            const titleEn = document.getElementById('titleEn').value;
            const blockElems = document.querySelectorAll('.block-data');
            
            let content = [];
            blockElems.forEach(el => content.push({ type: el.dataset.type, value: el.value }));

            if(!titleAr || content.length === 0) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

            let lessons = JSON.parse(localStorage.getItem('ct_lessons')) || [];
            lessons.push({ titleAr, titleEn, content });
            localStorage.setItem('ct_lessons', JSON.stringify(lessons));
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­!");
            location.reload();
        }

        window.onload = function() {
            const list = document.getElementById('ct-lessons-list');
            const lessons = JSON.parse(localStorage.getItem('ct_lessons')) || [];
            list.innerHTML = lessons.map((l, i) => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333;">
                    <span>${l.titleAr}</span>
                    <button onclick="deleteLesson(${i})" style="color:red; background:none; border:none; cursor:pointer;">Ø­Ø°Ù ğŸ—‘ï¸</button>
                </div>
            `).join('');
        };

        function deleteLesson(i) {
            let lessons = JSON.parse(localStorage.getItem('ct_lessons'));
            lessons.splice(i, 1);
            localStorage.setItem('ct_lessons', JSON.stringify(lessons));
            location.reload();
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
    
    <script>
    const COLLECTION = "ct"; // ğŸ’¡ ØºÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ us_lessons Ø£Ùˆ rad_protection Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©

    async function saveData() {
        const title = document.querySelector('input').value;
        const desc = document.querySelector('textarea').value;
        
        await db.collection(COLLECTION).add({
            title, desc, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        location.reload();
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­Ø°Ù
    window.onload = async function() {
        const snap = await db.collection(COLLECTION).orderBy("createdAt", "desc").get();
        document.getElementById('data-list').innerHTML = snap.docs.map(doc => `
            <div style="display:flex; justify-content:space-between; padding:10px;">
                <span>${doc.data().title}</span>
                <button onclick="db.collection('${COLLECTION}').doc('${doc.id}').delete().then(()=>location.reload())">Ø­Ø°Ù ğŸ—‘ï¸</button>
            </div>
        `).join('');
    };
</script>
</body>
</html>