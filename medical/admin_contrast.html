<!DOCTYPE html>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
    firebase.auth().onAuthStateChanged((user) => {
        if (!user) window.location.href = "login.html";
    });

    function logout() {
        firebase.auth().signOut().then(() => {
            window.location.href = "login.html";
        });
    }
</script>

<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù„ÙˆÙ†Ø© - ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ©</title>
    <style>
        .input-group { margin-bottom: 15px; }
        input, textarea, select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--orange); 
            background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; 
        }
        label { display: block; margin-bottom: 5px; color: var(--yellow); }
        .edit-badge { background: var(--yellow); color: var(--navy); padding: 5px 10px; border-radius: 5px; display: none; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <nav>
        <a href="admin_hub.html" class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµØ¨ØºØ§Øª ğŸ’‰</a>
        <button class="btn-primary" onclick="location.href='admin_hub.html'" style="width:auto; padding: 5px 15px;">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </nav>

    <div class="container">
        <div class="card">
            <div id="edit-indicator" class="edit-badge">ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù†Ø´Ø· âœï¸</div>
            <h2 id="form-title" style="color:var(--orange); text-align:center;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ù…Ù„ÙˆÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            
            <div class="input-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ar/En):</label>
                <input type="text" id="con-name" placeholder="Ù…Ø«Ù„Ø§Ù‹: Omnipaque (Iohexol)">
            </div>

            <div class="input-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                <input type="text" id="con-type" placeholder="Ù…Ø«Ù„Ø§Ù‹: Non-ionic Iodinated">
            </div>

            <div class="input-group">
                <label>Ø§Ù„ØªØ±ÙƒÙŠØ²:</label>
                <input type="text" id="con-prop" placeholder="Ù…Ø«Ù„Ø§Ù‹: 350 mgI/ml">
            </div>
            
            <div class="input-group">
                <label>Ø§Ù„Ø®ØµØ§Ø¦Øµ ÙˆØ§Ù„Ø¢Ù„ÙŠØ©:</label>
                <input type="text" id="con-mech" placeholder="Ø´Ø±Ø­ Ù…Ø¨Ø³Ø· Ø¹Ù† Ø§Ù„Ø¢Ù„ÙŠØ© ÙˆØ§Ù„Ø®ØµØ§Ø¦Øµ">
            </div>

            <div class="input-group">
                <label>Ø¯ÙˆØ§Ø¹ÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„:</label>
                <textarea id="con-notes" rows="3" placeholder="Ù…ØªÙ‰ ØªÙØ³ØªØ®Ø¯Ù…..."></textarea>
            </div>
            
            <div class="input-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©:</label>
                <textarea id="con-safety" rows="3" placeholder="Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª ÙˆÙ…ÙˆØ§Ù†Ø¹ Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„..."></textarea>
            </div>
            
            <div class="input-group">
                <label>Ø§Ù„ÙˆØµÙ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠ:</label>
                <textarea id="con-desc" rows="3" placeholder="ØµÙ Ø´ÙƒÙ„ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆÙ„Ø²ÙˆØ¬ØªÙ‡Ø§..."></textarea>
            </div>

            <div class="input-group">
                <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <input type="file" id="con-img" accept="image/*">
                <img id="edit-preview" style="width:100px; display:none; margin-top:10px; border-radius:8px;">
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" id="save-btn" onclick="saveContrast()">ğŸš€ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨</button>
                <button class="btn-primary" id="cancel-btn" style="background:#555; display:none;" onclick="location.reload()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>

        <div class="card">
            <h3 style="color:var(--yellow);">ğŸ“‚ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨:</h3>
            <div id="con-list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <script>
        let editingId = null;
        const COLLECTION = "contrast";

        async function saveContrast() {
            const name = document.getElementById('con-name').value;
            const type = document.getElementById('con-type').value;
            const prop = document.getElementById('con-prop').value;
            const mech = document.getElementById('con-mech').value;
            const notes = document.getElementById('con-notes').value;
            const safety = document.getElementById('con-safety').value;
            const desc = document.getElementById('con-desc').value;
            const imgFile = document.getElementById('con-img').files[0];

            if(!name || !notes) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©!");

            let imageData = document.getElementById('edit-preview').src || "";
            if (imgFile) {
                imageData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(imgFile);
                });
            }

            const data = { 
                name, type, prop, mech, notes, safety, desc, 
                img: imageData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if(editingId) {
                    await db.collection(COLLECTION).doc(editingId).update(data);
                    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection(COLLECTION).add(data);
                    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø­Ø§Ø¨!");
                }
                location.reload();
            } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
        }

        window.onload = async function() {
            const list = document.getElementById('con-list');
            const snap = await db.collection(COLLECTION).orderBy("name", "asc").get();
            
            list.innerHTML = snap.docs.map(doc => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333; align-items:center;">
                    <span><b>${doc.data().name}</b></span>
                    <div>
                        <button onclick="editContrast('${doc.id}')" style="color:var(--yellow); background:none; border:none; cursor:pointer; margin-left:15px;">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button>
                        <button onclick="deleteContrast('${doc.id}')" style="color:red; background:none; border:none; cursor:pointer;">Ø­Ø°Ù ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        async function editContrast(id) {
            editingId = id;
            const doc = await db.collection(COLLECTION).doc(id).get();
            const d = doc.data();
            
            document.getElementById('con-name').value = d.name || "";
            document.getElementById('con-type').value = d.type || "";
            document.getElementById('con-prop').value = d.prop || "";
            document.getElementById('con-mech').value = d.mech || "";
            document.getElementById('con-notes').value = d.notes || "";
            document.getElementById('con-safety').value = d.safety || "";
            document.getElementById('con-desc').value = d.desc || "";
            
            if(d.img) {
                const prev = document.getElementById('edit-preview');
                prev.src = d.img;
                prev.style.display = "block";
            }

            document.getElementById('form-title').innerText = "ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©";
            document.getElementById('edit-indicator').style.display = "block";
            document.getElementById('cancel-btn').style.display = "block";
            window.scrollTo(0, 0);
        }

        async function deleteContrast(id) {
            if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await db.collection(COLLECTION).doc(id).delete();
                location.reload();
            }
        }
    </script>
</body>
</html>