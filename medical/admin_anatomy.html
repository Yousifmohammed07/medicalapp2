<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ø¯ÙŠ Ø§Ù„ØªØ´Ø±ÙŠØ­ - ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ©</title>
    <style>
        :root { --grad: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); }
        .admin-section { background: #0a1120; border-radius: 20px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(255, 215, 0, 0.2); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--yellow); font-weight: bold; }
        input, select, textarea { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #1e293b; 
            background: #0f172a; color: white; outline: none;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© */
        .picker-container {
            position: relative; width: 100%; max-width: 500px; margin: 15px auto;
            border: 2px dashed var(--orange); border-radius: 15px; overflow: hidden; cursor: crosshair;
        }
        #preview-img { width: 100%; display: none; }
        #target-marker {
            position: absolute; width: 25px; height: 25px; border: 2px solid #fff;
            border-radius: 50%; background: rgba(255, 140, 0, 0.6);
            transform: translate(-50%, -50%); display: none; pointer-events: none;
        }
        .instr-hint { font-size: 0.85rem; color: var(--orange); text-align: center; margin-top: 5px; }

        .btn-premium { 
            width: 100%; padding: 15px; background: var(--grad); color: #000; border: none; 
            border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s;
        }
        .data-card { background: #0f172a; padding: 15px; border-radius: 12px; margin-top: 10px; border-right: 4px solid var(--orange); }
    </style>
</head>
<body>
    <nav>
        <a href="admin_hub.html" class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´Ø±ÙŠØ­ ğŸ¦´</a>
        <button class="btn-primary" onclick="location.href='admin_hub.html'" style="width:auto; padding: 5px 15px;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </nav>

    <div class="container">
        <div class="admin-section">
            <h2 style="color:var(--yellow); text-align:center;">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</h2>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                <div class="input-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…:</label>
                    <input type="text" id="sec-title" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØ´Ø±ÙŠØ­ Ø§Ù„ØµØ¯Ø± X-ray">
                </div>
                <div class="input-group">
                    <label>Ø£ÙŠÙ‚ÙˆÙ†Ø©:</label>
                    <input type="text" id="sec-icon" placeholder="ğŸ¦´">
                </div>
            </div>
            <button class="btn-premium" onclick="saveSection()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… ğŸš€</button>
        </div>

        <div class="admin-section">
            <h2 style="color:var(--orange); text-align:center;">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ØªØ­Ø¯ÙŠØ¯</h2>
            <div class="input-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
                <select id="sec-select"><option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option></select>
            </div>
            
            <div class="input-group">
                <label>Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø£Ø´Ø¹Ø©:</label>
                <input type="file" id="q-img-file" accept="image/*" onchange="handleImgPreview(this)">
            </div>

            <div class="picker-container" onclick="setMarkerPos(event)">
                <img id="preview-img">
                <div id="target-marker"></div>
            </div>
            <p class="instr-hint">ğŸ’¡ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø¯ÙŠØ¯Ù‡ ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡</p>

            <div class="input-group">
                <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                <input type="text" id="q-text" placeholder="Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡ØŸ">
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <input type="text" id="opt-0" placeholder="Ø®ÙŠØ§Ø± 1">
                <input type="text" id="opt-1" placeholder="Ø®ÙŠØ§Ø± 2">
                <input type="text" id="opt-2" placeholder="Ø®ÙŠØ§Ø± 3">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top:15px;">
                <input type="number" id="correct-idx" placeholder="Ø§Ù„Ø¬ÙˆØ§Ø¨ (0-2)">
                <input type="text" id="q-note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù„Ù…ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>

            <button class="btn-premium" style="margin-top:20px;" onclick="saveAnatomyQuestion()">Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨ âœ…</button>
        </div>

        <div class="admin-section">
            <h3>ğŸ“‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div id="management-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const COLLECTION = "anatomy_challenges";
        let posX = 0; 
        let posY = 0;
        let selectedImgBase64 = "";

        // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
        function handleImgPreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('preview-img');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    selectedImgBase64 = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 2. Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø°ÙƒÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        function setMarkerPos(event) {
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙƒÙ†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª
            posX = ((event.clientX - rect.left) / rect.width) * 100;
            posY = ((event.clientY - rect.top) / rect.height) * 100;

            const marker = document.getElementById('target-marker');
            marker.style.left = posX + "%";
            marker.style.top = posY + "%";
            marker.style.display = "block";
        }

        // 3. Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…
        async function saveSection() {
            const title = document.getElementById('sec-title').value;
            const icon = document.getElementById('sec-icon').value || "ğŸ¦´";
            if(!title) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†!");

            await db.collection(COLLECTION).add({
                title, icon, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù…!"); location.reload();
        }

        // 4. Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ (Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø© Ù„ØªØ¬Ù†Ø¨ Ø­Ø¯ 1MB)
        async function saveAnatomyQuestion() {
            const secId = document.getElementById('sec-select').value;
            const q = document.getElementById('q-text').value;
            const correct = document.getElementById('correct-idx').value;

            if(!secId || !q || !selectedImgBase64 || correct === "") return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©!");

            const questionData = {
                q, posX, posY, img: selectedImgBase64,
                options: [document.getElementById('opt-0').value, document.getElementById('opt-1').value, document.getElementById('opt-2').value],
                correct: parseInt(correct),
                note: document.getElementById('q-note').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection(COLLECTION).doc(secId).collection("questions").add(questionData);
                alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨Ù†Ø¬Ø§Ø­!"); location.reload();
            } catch (e) { alert(e.message); }
        }

        // 5. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        window.onload = async function() {
            const snap = await db.collection(COLLECTION).orderBy("createdAt", "desc").get();
            const select = document.getElementById('sec-select');
            const list = document.getElementById('management-list');
            
            select.innerHTML = `<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>` + 
                snap.docs.map(doc => `<option value="${doc.id}">${doc.data().title}</option>`).join('');

            list.innerHTML = "";
            for (const doc of snap.docs) {
                const d = doc.data();
                const qSnap = await db.collection(COLLECTION).doc(doc.id).collection("questions").get();
                
                list.innerHTML += `
                    <div class="data-card">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${d.icon} ${d.title}</b>
                            <button onclick="if(confirm('Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ')) db.collection('${COLLECTION}').doc('${doc.id}').delete().then(()=>location.reload())" style="color:red; background:none; border:none; cursor:pointer;">Ø­Ø°Ù</button>
                        </div>
                        <small style="color:#888;">ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${qSnap.size} ØªØ­Ø¯ÙŠØ§Øª ØªØ´Ø±ÙŠØ­ÙŠØ©</small>
                    </div>`;
            }
        };
    </script>
</body>
</html>
