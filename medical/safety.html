<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>ØªØ­Ø¯ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø¹ÙŠØ© ÙˆØ§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠØ© - ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ©</title>
    <style>
        .safety-header { text-align: center; padding: 30px; background: var(--card-bg); border-bottom: 2px solid var(--orange); }
        .filter-container { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .filter-btn { 
            padding: 10px 20px; border-radius: 20px; border: 1px solid var(--orange); 
            background: transparent; color: white; cursor: pointer; transition: 0.3s;
        }
        .filter-btn.active { background: var(--orange); color: var(--navy); font-weight: bold; }

        .challenge-container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .safety-card { background: var(--card-bg); border-radius: 20px; padding: 25px; text-align: center; border: 2px solid var(--yellow); }
        .safety-img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 15px; margin-bottom: 20px; background: #000; padding: 10px; }
        
        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn-safe { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-unsafe { background: #c0392b; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-conditional { background: var(--yellow); color: var(--navy); border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; grid-column: span 2; }

        .feedback-box { display: none; margin-top: 20px; padding: 20px; border-radius: 15px; line-height: 1.6; text-align: right; }
        #loading-text { text-align: center; color: var(--orange); display: none; }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo">ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ© ğŸ“·</a>
        <div class="dropdown">
            <button onclick="toggleMenu()" class="dropbtn">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â˜°</button>
            <div id="myDropdown" class="dropdown-content">
                <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <a href="safety.html">ØªØ­Ø¯ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</a>
                <a href="atlas.html">Ø£Ø·Ù„Ø³ Ø§Ù„ÙˆØ¶Ø¹ÙŠØ§Øª</a>
                <a href="xray.html">Ø¯Ø±ÙˆØ³ Ø§Ù„Ø£Ø´Ø¹Ø©</a>
            </div>
        </div>
    </nav>

    <div class="safety-header">
        <h1 style="color:var(--yellow)">ğŸ›¡ï¸ ØªØ­Ø¯ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</h1>
        <p>Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ø³Ø§Ù… Ø§Ù„Ø¢Ù…Ù†Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©</p>
    </div>

    <div class="filter-container">
        <button class="filter-btn active" onclick="setDevice('All', this)">Ø§Ù„ÙƒÙ„</button>
        <button class="filter-btn" onclick="setDevice('MRI', this)">Ø§Ù„Ø±Ù†ÙŠÙ† (MRI)</button>
        <button class="filter-btn" onclick="setDevice('CT', this)">Ø§Ù„Ù…ÙØ±Ø§Ø³ (CT)</button>
        <button class="filter-btn" onclick="setDevice('X-ray', this)">Ø§Ù„Ø£Ø´Ø¹Ø© (X-ray)</button>
    </div>

    <div class="challenge-container">
        <div id="loading-text">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨...</div>
        <div id="game-area">
            <div class="card" style="text-align:center;">
                <h3>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†</h3>
                <p>Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ØªÙŠ Ø£Ø¶ÙØªÙ‡Ø§ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
                <button id="start-btn" class="btn-primary" onclick="loadNextChallenge()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ ğŸš€</button>
             </div>
        </div>

        <div id="feedback" class="feedback-box"></div>
        <button id="next-btn" class="btn-primary" style="display:none; margin-top:10px;" onclick="loadNextChallenge()">Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let currentDevice = 'All';
        let allChallenges = [];
        let currentChallenge = null;
        const COLLECTION = "safety"; // Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙŠ Firebase

        function toggleMenu() { document.getElementById("myDropdown").classList.toggle("show"); }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.onload = async function() {
            const loading = document.getElementById('loading-text');
            loading.style.display = "block";
            try {
                const snap = await db.collection(COLLECTION).get();
                allChallenges = snap.docs.map(doc => doc.data());
                loading.style.display = "none";
                console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª:", allChallenges.length);
            } catch (e) {
                loading.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
                console.error(e);
            }
        };

        function setDevice(device, btn) {
            currentDevice = device;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadNextChallenge();
        }

        function loadNextChallenge() {
            let pool = (currentDevice === 'All') ? allChallenges : allChallenges.filter(c => c.device === currentDevice);

            if (pool.length === 0) {
                document.getElementById('game-area').innerHTML = `
                    <div class="card" style="text-align:center;">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ§Øª Ù…Ø¶Ø§ÙØ© ÙÙŠ Ù‚Ø³Ù… <b>${currentDevice}</b> Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                        <p style="font-size:0.8rem; color:gray;">Ø£Ø¶Ù ØªØ­Ø¯ÙŠØ§Øª Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªØ¸Ù‡Ø± Ù‡Ù†Ø§.</p>
                    </div>`;
                return;
            }

            currentChallenge = pool[Math.floor(Math.random() * pool.length)];
            
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = `
                <div class="safety-card">
                    <span style="background:var(--orange); color:black; padding:2px 10px; border-radius:5px; font-size:0.8rem; float:left;">${currentChallenge.device}</span>
                    <h3 style="margin-top:20px;">${currentChallenge.item || currentChallenge.title}</h3>
                    <img src="${currentChallenge.img || currentChallenge.image}" class="safety-img">
                    <p>Ù…Ø§ Ù‡Ùˆ ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø³Ù…ØŸ</p>
                    
                    <div class="action-btns">
                        <button class="btn-safe" onclick="checkSafety('safe')">âœ… Ø¢Ù…Ù†</button>
                        <button class="btn-unsafe" onclick="checkSafety('unsafe')">âŒ Ø®Ø·Ø±</button>
                        <button class="btn-conditional" onclick="checkSafety('conditional')">âš ï¸ Ù…Ø³Ù…ÙˆØ­ Ø¨Ø´Ø±Ø·</button>
                    </div>
                </div>
            `;
            
            document.getElementById('feedback').style.display = "none";
            document.getElementById('next-btn').style.display = "none";
        }

        function checkSafety(userChoice) {
            const feedback = document.getElementById('feedback');
            feedback.style.display = "block";
            document.getElementById('next-btn').style.display = "block";

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const correctStatus = currentChallenge.status || currentChallenge.correctAnswer;

            if (userChoice === correctStatus) {
                feedback.style.background = "rgba(39, 174, 150, 0.2)";
                feedback.style.border = "1px solid #27ae60";
                feedback.innerHTML = `<h3 style="color:#27ae60; margin-top:0;">âœ”ï¸ Ø£Ø­Ø³Ù†ØªØŒ Ù‚Ø±Ø§Ø± ØµØ­ÙŠØ­!</h3><p>${currentChallenge.explanation || currentChallenge.desc}</p>`;
            } else {
                feedback.style.background = "rgba(192, 57, 43, 0.2)";
                feedback.style.border = "1px solid #c0392b";
                const statusMap = { 'safe': 'Ø¢Ù…Ù†', 'unsafe': 'ØºÙŠØ± Ø¢Ù…Ù†/Ø®Ø·Ø±', 'conditional': 'Ù…Ø³Ù…ÙˆØ­ Ø¨Ø´Ø±Ø·' };
                feedback.innerHTML = `
                    <h3 style="color:#e74c3c; margin-top:0;">âŒ Ù„Ù„Ø£Ø³ÙØŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©</h3>
                    <p>Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ: <b>${statusMap[correctStatus]}</b></p>
                    <p>${currentChallenge.explanation || currentChallenge.desc}</p>`;
            }
            
            document.querySelector('.action-btns').style.opacity = "0.3";
            document.querySelector('.action-btns').style.pointerEvents = "none";
        }
    </script>
</body>
</html>