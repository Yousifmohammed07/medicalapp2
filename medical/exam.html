<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ© - Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
    <style>
        /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… */
        :root { --grad: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); }
        .levels-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 20px 0; }
        .track-card { 
            background: #0a1120; border-radius: 20px; padding: 25px; text-align: center; 
            border: 1px solid rgba(255, 215, 0, 0.1); cursor: pointer; transition: 0.3s;
        }
        .track-card:hover:not(.locked) { transform: translateY(-5px); border-color: var(--orange); }
        .track-card.locked { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .track-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        
        #quiz-screen { display: none; max-width: 700px; margin: 0 auto; }
        .question-card { background: #0a1120; border-radius: 25px; padding: 30px; border: 1px solid #1e293b; }
        .q-img { width: 100%; max-height: 350px; object-fit: contain; border-radius: 15px; margin-bottom: 20px; background: #000; padding: 10px; }
        
        .option-btn { 
            width: 100%; padding: 18px; margin-bottom: 12px; border-radius: 15px; border: 1px solid #1e293b;
            background: #0f172a; color: white; cursor: pointer; text-align: right; font-size: 1.1rem; transition: 0.3s;
        }
        .option-btn.selected { border-color: var(--orange); background: rgba(255, 140, 0, 0.1); }
        .option-btn.correct { background: #27ae60 !important; color: white; }
        .option-btn.wrong { background: #c0392b !important; color: white; }

        .progress-container { width: 100%; height: 8px; background: #1e293b; border-radius: 10px; margin-bottom: 25px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--grad); width: 0%; transition: 0.5s; }
        
        .feedback-box { margin-top: 20px; padding: 20px; border-radius: 15px; display: none; background: rgba(255, 255, 255, 0.05); border-right: 5px solid var(--orange); }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo">Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ© ğŸ“·</a>
        <div class="nav-links">
            <span id="user-progress-text" style="color:var(--yellow); font-weight:bold;">ğŸ† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø¯Ù…: 1</span>
        </div>
    </nav>

    <div class="container">
        <div id="dashboard">
            <header style="text-align:center; padding: 40px 0;">
                <h1 style="color:var(--yellow); font-size: 2.5rem;">Ù…Ø³Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h1>
                <p>Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ù„ÙØªØ­ Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</p>
            </header>
            <div id="levels-grid" class="levels-grid">
                <p style="text-align:center; color:var(--orange);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ...</p>
            </div>
        </div>

        <div id="quiz-screen">
            <div class="progress-container"><div id="progress-fill"></div></div>
            <div class="question-card">
                <span id="q-counter" style="color:var(--orange); font-weight:bold; float:left;">Ø³Ø¤Ø§Ù„ 1</span>
                <h2 id="question-text" style="margin-top:40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                <div id="image-container"></div>
                <div id="options-area" style="margin-top:25px;"></div>
                <div id="feedback" class="feedback-box">
                    <h4 id="feedback-status"></h4>
                    <p id="explanation-text"></p>
                </div>
                <div style="margin-top:30px;">
                    <button id="submit-btn" class="btn-primary" onclick="submitAnswer()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© âœ…</button>
                    <button id="next-btn" class="btn-primary" style="display:none;" onclick="nextQuestion()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const COLLECTION = "exams";
        let unlockedLevel = parseInt(localStorage.getItem('unlockedLevel')) || 1;
        
        let currentLevelNum = 1;
        let currentQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let selectedIdx = null;

        document.getElementById('user-progress-text').innerText = `ğŸ† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø¯Ù…: ${unlockedLevel}`;

        async function loadDashboard() {
            const grid = document.getElementById('levels-grid');
            try {
                const snap = await db.collection(COLLECTION).orderBy("num", "asc").get();
                if(snap.empty) {
                    grid.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ§Ø­Ø©.</p>";
                    return;
                }
                grid.innerHTML = "";
                snap.docs.forEach(doc => {
                    const lvl = doc.data();
                    const isLocked = lvl.num > unlockedLevel;
                    grid.innerHTML += `
                        <div class="track-card ${isLocked ? 'locked' : ''}" onclick="${isLocked ? '' : `startExam('${doc.id}', ${lvl.num})`}">
                            <span class="track-icon">${lvl.icon || 'ğŸ“š'}</span>
                            <h3>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${lvl.num}</h3>
                            <p>${lvl.title}</p>
                            <div style="margin-top:10px; font-size:0.9rem; color:var(--orange)">
                                ${isLocked ? 'ğŸ”’ Ù…ØºÙ„Ù‚' : (lvl.num < unlockedLevel ? 'âœ… Ù…ÙƒØªÙ…Ù„' : 'ğŸ”“ Ù…ØªØ§Ø­')}
                            </div>
                        </div>`;
                });
            } catch (e) { grid.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„."; }
        }

        async function startExam(docId, lvlNum) {
            try {
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©
                const qSnap = await db.collection(COLLECTION).doc(docId).collection("questions").orderBy("createdAt", "asc").get();
                currentQuestions = qSnap.docs.map(doc => doc.data());
                currentLevelNum = lvlNum;

                if(currentQuestions.length === 0) return alert("Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø©.");

                currentIdx = 0; score = 0;
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('quiz-screen').style.display = 'block';
                showQuestion();
            } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©."); }
        }

        function showQuestion() {
            const q = currentQuestions[currentIdx];
            selectedIdx = null;
            document.getElementById('q-counter').innerText = `Ø³Ø¤Ø§Ù„ ${currentIdx + 1} / ${currentQuestions.length}`;
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('image-container').innerHTML = q.img ? `<img src="${q.img}" class="q-img">` : "";
            
            const optionsArea = document.getElementById('options-area');
            optionsArea.innerHTML = q.options.map((opt, i) => `
                <button class="option-btn" onclick="selectOption(${i})" id="opt-${i}">${opt}</button>
            `).join('');

            document.getElementById('progress-fill').style.width = `${(currentIdx / currentQuestions.length) * 100}%`;
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('submit-btn').style.display = 'block';
            document.getElementById('next-btn').style.display = 'none';
        }

        function selectOption(i) {
            selectedIdx = i;
            document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`opt-${i}`).classList.add('selected');
        }

        function submitAnswer() {
            if(selectedIdx === null) return alert("Ø§Ø®ØªØ± Ø¥Ø¬Ø§Ø¨Ø©!");
            const q = currentQuestions[currentIdx];
            const feedback = document.getElementById('feedback');
            document.querySelectorAll('.option-btn').forEach(btn => btn.style.pointerEvents = 'none');

            if(selectedIdx === q.correct) {
                score++;
                document.getElementById(`opt-${selectedIdx}`).classList.add('correct');
                document.getElementById('feedback-status').innerText = "âœ”ï¸ ØµØ­!";
            } else {
                document.getElementById(`opt-${selectedIdx}`).classList.add('wrong');
                document.getElementById(`opt-${q.correct}`).classList.add('correct');
                document.getElementById('feedback-status').innerText = "âŒ Ø®Ø·Ø£";
            }
            document.getElementById('explanation-text').innerText = q.exp || "";
            feedback.style.display = 'block';
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
        }

        function nextQuestion() {
            currentIdx++;
            if(currentIdx < currentQuestions.length) showQuestion();
            else finishExam();
        }

        function finishExam() {
            const percent = (score / currentQuestions.length) * 100;
            const passed = percent >= 70;
            const quizScreen = document.getElementById('quiz-screen');
            quizScreen.innerHTML = `
                <div class="question-card" style="text-align:center;">
                    <h2 style="color:var(--yellow)">${passed ? 'ğŸ‰ Ø£Ø­Ø³Ù†Øª!' : 'ğŸ” Ø­Ø§ÙˆÙ„ Ø«Ø§Ù†ÙŠØ©'}</h2>
                    <div style="font-size:4rem; margin:20px 0;">${score} / ${currentQuestions.length}</div>
                    <p>Ø§Ù„Ù†Ø³Ø¨Ø©: ${Math.round(percent)}%</p>
                    <button class="btn-primary" onclick="location.reload()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³Ø§Ø±</button>
                </div>`;

            if(passed && currentLevelNum === unlockedLevel) {
                unlockedLevel++;
                localStorage.setItem('unlockedLevel', unlockedLevel);
            }
        }
        window.onload = loadDashboard;
    </script>
</body>
</html>