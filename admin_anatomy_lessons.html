<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±ÙˆØ³ Ø§Ù„ØªØ´Ø±ÙŠØ­ - ÙƒØ§Ù…ÙŠØ±Ø§ Ø·Ø¨ÙŠØ©</title>
    <style>
        .admin-section { background: #0a1120; border-radius: 20px; padding: 25px; border: 1px solid rgba(255, 215, 0, 0.2); }
        .input-group { margin-bottom: 15px; }
        input, textarea, select { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--orange); 
            background: #0f172a; color: white; outline: none;
        }
        label { display: block; margin-bottom: 5px; color: var(--yellow); font-weight: bold; }
        .edit-active { border: 2px solid #27ae60 !important; }
    </style>
</head>
<body>
    <nav>
        <a href="admin_hub.html" class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ ğŸ“–</a>
        <button class="btn-primary" onclick="location.href='admin_hub.html'" style="width:auto; padding: 5px 15px;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </nav>

    <div class="container">
        <div class="admin-section" id="lesson-form">
            <h2 id="form-title" style="color:var(--orange); text-align:center;">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ ØªØ´Ø±ÙŠØ­ÙŠ Ø¬Ø¯ÙŠØ¯</h2>
            
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                <div class="input-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³:</label>
                    <input type="text" id="lesson-title" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØ´Ø±ÙŠØ­ Ø§Ù„Ù‚ÙØµ Ø§Ù„ØµØ¯Ø±ÙŠ">
                </div>
                <div class="input-group">
                    <label>Ø£ÙŠÙ‚ÙˆÙ†Ø© (Emoji):</label>
                    <input type="text" id="lesson-icon" placeholder="ğŸ«">
                </div>
            </div>

            <div class="input-group">
                <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³ (Ø´Ø±Ø­ Ù…ÙØµÙ„):</label>
                <textarea id="lesson-content" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ØªØ´Ø±ÙŠØ­ÙŠ Ù‡Ù†Ø§..."></textarea>
            </div>

            <div class="input-group">
                <label>ØµÙˆØ±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© (Atlas Image):</label>
                <input type="file" id="lesson-img" accept="image/*">
                <img id="edit-preview" style="display:none; width:100px; margin-top:10px; border-radius:8px; border:1px solid var(--orange);">
            </div>

            <button class="btn-primary" id="save-btn" onclick="saveAnatomyLesson()">ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³ ÙÙŠ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</button>
            <button class="btn-primary" id="cancel-btn" style="display:none; background:#555; margin-top:10px;" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <div class="card" style="margin-top:25px;">
            <h3>ğŸ“š Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:</h3>
            <div id="lessons-list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const COLLECTION = "anatomy_lessons";
        let editingId = null;
        let currentImgBase64 = "";

        async function saveAnatomyLesson() {
            const title = document.getElementById('lesson-title').value;
            const icon = document.getElementById('lesson-icon').value || "ğŸ¦´";
            const content = document.getElementById('lesson-content').value;
            const file = document.getElementById('lesson-img').files[0];

            if(!title || !content) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰!");

            let imgData = currentImgBase64;
            if(file) {
                imgData = await new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); });
            }

            const lessonData = { title, icon, content, img: imgData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };

            try {
                if(editingId) {
                    await db.collection(COLLECTION).doc(editingId).update(lessonData);
                    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³!");
                } else {
                    lessonData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection(COLLECTION).add(lessonData);
                    alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­!");
                }
                resetForm(); loadLessons();
            } catch (e) { alert(e.message); }
        }

        async function loadLessons() {
            const list = document.getElementById('lessons-list');
            const snap = await db.collection(COLLECTION).orderBy("createdAt", "desc").get();
            list.innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                return `
                <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #333;">
                    <span>${d.icon} <b>${d.title}</b></span>
                    <div>
                        <button onclick='prepareEdit("${doc.id}", ${JSON.stringify(d).replace(/'/g, "&apos;")})' style="color:var(--yellow); background:none; cursor:pointer; margin-left:10px;">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="if(confirm('Ø­Ø°ÙØŸ')) db.collection('${COLLECTION}').doc('${doc.id}').delete().then(()=>loadLessons())" style="color:red; background:none; cursor:pointer;">Ø­Ø°Ù</button>
                    </div>
                </div>`;
            }).join('');
        }

        function prepareEdit(id, data) {
            editingId = id;
            document.getElementById('lesson-title').value = data.title;
            document.getElementById('lesson-icon').value = data.icon;
            document.getElementById('lesson-content').value = data.content;
            currentImgBase64 = data.img || "";
            if(data.img) {
                document.getElementById('edit-preview').src = data.img;
                document.getElementById('edit-preview').style.display = "block";
            }
            document.getElementById('form-title').innerText = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³";
            document.getElementById('save-btn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø¢Ù†";
            document.getElementById('cancel-btn').style.display = "block";
            document.getElementById('lesson-form').classList.add('edit-active');
            window.scrollTo(0,0);
        }

        function resetForm() {
            editingId = null; currentImgBase64 = "";
            document.getElementById('lesson-title').value = "";
            document.getElementById('lesson-content').value = "";
            document.getElementById('edit-preview').style.display = "none";
            document.getElementById('form-title').innerText = "â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('save-btn').innerText = "ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³";
            document.getElementById('cancel-btn').style.display = "none";
            document.getElementById('lesson-form').classList.remove('edit-active');
        }

        window.onload = loadLessons;
    </script>
</body>
</html>